#!/bin/zsh

# Racing API Project - ETL Pipeline Script
# This script runs the daily ETL pipeline (cron-friendly)

set -e

export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

PROJECT_ROOT="$HOME/App/racing-api-project/racing-api-project"
VENV_PATH="$PROJECT_ROOT/.venv"
PYTHON_BIN="$VENV_PATH/bin/python"
ETL_MAIN="$PROJECT_ROOT/apps/racing-etl/src/racing_etl/main.py"

# Ensure logs directory exists
LOG_DIR="$PROJECT_ROOT/logs"
mkdir -p "$LOG_DIR"

echo "ETL Pipeline starting at $(date)"

# Verify virtual environment exists
if [[ ! -f "$PYTHON_BIN" ]]; then
    echo "ERROR: Virtual environment not found at $VENV_PATH"
    exit 1
fi

# Change to project directory and activate virtual environment
cd "$PROJECT_ROOT"
source "$VENV_PATH/bin/activate"

# Run ETL pipeline
echo "Starting ETL execution..."
"$PYTHON_BIN" "$ETL_MAIN"

echo "ETL Pipeline completed at $(date)"