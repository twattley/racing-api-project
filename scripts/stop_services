#!/bin/zsh

# Racing API Project - Service Shutdown Script
# This script stops all running services by killing their tmux sessions
# and any processes running on their ports

set -e

# Set up PATH for cron environment
export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

TMUX="/opt/homebrew/bin/tmux"

# Define service ports
API_PORT=8010
FRONTEND_PORT=5174

echo "Stopping Racing API services at $(date)"

# Function to check if tmux session exists
session_exists() {
    $TMUX has-session -t "$1" 2>/dev/null
}

# Function to kill process on a specific port
kill_port() {
    local port="$1"
    local pids=$(lsof -ti tcp:$port 2>/dev/null || true)
    
    if [[ -n "$pids" ]]; then
        echo "üî™ Killing processes on port $port (PIDs: $pids)..."
        echo "$pids" | xargs kill -9 2>/dev/null || true
        echo "‚úì Port $port cleared"
    else
        echo "‚ö†Ô∏è  No processes found on port $port"
    fi
}

# Function to stop a service
stop_service() {
    local service_name="$1"
    local alt_name="$2"
    
    local stopped=false
    
    if session_exists "$service_name"; then
        echo "üõë Stopping $service_name..."
        $TMUX kill-session -t "$service_name"
        echo "‚úì $service_name stopped"
        stopped=true
    fi
    
    if [[ -n "$alt_name" ]] && session_exists "$alt_name"; then
        echo "üõë Stopping $alt_name..."
        $TMUX kill-session -t "$alt_name"
        echo "‚úì $alt_name stopped"
        stopped=true
    fi
    
    if ! $stopped; then
        echo "‚ö†Ô∏è  $service_name session not found, skipping..."
    fi
}

# Stop all services
stop_service "racing-api" "racingapi"
stop_service "racing-api-frontend" "webapp"
stop_service "trader" ""

echo ""
echo "Cleaning up ports..."

# Kill any remaining processes on service ports
kill_port $API_PORT
kill_port $FRONTEND_PORT

echo ""
echo "üèÅ All services stopped successfully!"
echo ""
echo "Services stopped at: $(date)"