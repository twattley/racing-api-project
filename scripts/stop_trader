#!/bin/zsh

# Racing API Project - Trader Shutdown Script
# This script stops the trader by killing its tmux session

set -e

# Set up PATH for cron environment
export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

TMUX="/opt/homebrew/bin/tmux"

echo "Stopping trader at $(date)"

# Function to check if tmux session exists
session_exists() {
    $TMUX has-session -t "$1" 2>/dev/null
}

# Function to stop a service
stop_service() {
    local service_name="$1"
    local alt_name="$2"
    
    local stopped=false
    
    if session_exists "$service_name"; then
        echo "üõë Stopping $service_name..."
        $TMUX kill-session -t "$service_name"
        echo "‚úì $service_name stopped"
        stopped=true
    fi
    
    if [[ -n "$alt_name" ]] && session_exists "$alt_name"; then
        echo "üõë Stopping $alt_name..."
        $TMUX kill-session -t "$alt_name"
        echo "‚úì $alt_name stopped"
        stopped=true
    fi
    
    if ! $stopped; then
        echo "‚ö†Ô∏è  $service_name session not found, skipping..."
    fi
}

# Stop only the trader service
stop_service "trader" ""

echo ""
echo "üèÅ Trader stopped successfully!"
echo ""
echo "Trader stop completed at: $(date)"
