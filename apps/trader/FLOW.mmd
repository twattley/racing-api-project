---
title: Trader Application Flow
---
flowchart TB
    subgraph INIT["ðŸš€ Initialisation"]
        Start([Start]) --> InitClients[Initialise Betfair & Postgres Clients]
        InitClients --> GetRaceTimes[Get Min/Max Race Times]
    end

    subgraph MAIN_LOOP["ðŸ”„ Main Trading Loop"]
        GetRaceTimes --> CheckNetwork{Network Available?}
        CheckNetwork -- No --> WaitNetwork[Wait for Recovery]
        WaitNetwork -- Recovered --> CheckNetwork
        WaitNetwork -- Timeout --> Exit([Exit])
        
        CheckNetwork -- Yes --> UpdatePrices[Update Prices from Betfair]
        UpdatePrices --> RunCycle[Run Trading Cycle]
        
        RunCycle --> CheckRaceTime{Past Max Race Time?}
        CheckRaceTime -- Yes --> Exit
        CheckRaceTime -- No --> Sleep[Sleep 10 seconds]
        Sleep --> CheckNetwork
    end

    subgraph PRICE_SERVICE["ðŸ’° Price Service"]
        UpdatePrices --> FetchMarkets[Fetch Live Markets]
        FetchMarkets --> SimulatePlaces[Simulate Place Probabilities]
        SimulatePlaces --> StorePrices[Store to betfair_prices Table]
    end

    subgraph TRADING_CYCLE["ðŸ“Š Trading Cycle"]
        RunCycle --> Reconcile
        
        subgraph RECONCILE["1ï¸âƒ£ Reconciliation"]
            Reconcile[Reconcile with Betfair] --> GetOrders[Get Current Orders]
            GetOrders --> ProcessComplete[Process EXECUTION_COMPLETE]
            GetOrders --> ProcessExecutable[Process EXECUTABLE]
            ProcessComplete --> UpsertBetLog[Upsert to bet_log]
            ProcessComplete --> CleanPending[Remove from pending_orders]
            ProcessExecutable --> UpsertPending[Upsert to pending_orders]
        end

        UpsertBetLog --> FetchState
        UpsertPending --> FetchState
        CleanPending --> FetchState

        subgraph FETCH["2ï¸âƒ£ Fetch Selection State"]
            FetchState[Query v_selection_state View] --> ConvertModels[Convert to SelectionState Objects]
            ConvertModels --> CheckEmpty{Selections Exist?}
            CheckEmpty -- No --> NoAction([Return Empty])
        end

        CheckEmpty -- Yes --> Decide

        subgraph DECIDE["3ï¸âƒ£ Decision Engine"]
            direction TB
            Decide[For Each Selection] --> CheckValid{Valid?}
            CheckValid -- No --> HandleInvalid[Check for Cash Out / Cancels]
            
            CheckValid -- Yes --> CheckTime{Time to Race?}
            
            CheckTime -- ">2 hours" --> EarlyBird
            CheckTime -- "â‰¤2 hours" --> NormalMode

            subgraph EarlyBird["ðŸ¦ Early Bird Mode"]
                EBCheck{Early Bird Orders Exist?}
                EBCheck -- Yes --> EBSkip[Skip - Let Orders Sit]
                EBCheck -- No --> EBGenerate[Generate Scatter Orders]
                EBGenerate --> EBOffsets[Calculate Tick Offsets]
                EBOffsets --> EBSplit[Random Stake Split]
                EBSplit --> EBDelays[Add Staggered Delays]
            end

            subgraph NormalMode["âš¡ Normal Mode"]
                CancelEB[Cancel Any Early Bird Orders]
                CancelEB --> CheckValidations
                
                subgraph CheckValidations["Validation Checks"]
                    direction TB
                    V1{Runner Removed?}
                    V2{Place Terms Changed?}
                    V3{Short Price Removed?}
                    V4{Fully Matched?}
                    V5{At Stake Limit?}
                end
                
                CheckValidations --> CheckPrice{Price Acceptable?}
                CheckPrice -- No --> WaitPrice[Skip - Price Not Right]
                CheckPrice -- Yes --> CalcSize[Calculate Bet Size]
                CalcSize --> CreateOrder[Create Order]
            end
        end

        EBDelays --> CollectOrders
        EBSkip --> CollectOrders
        HandleInvalid --> CollectOrders
        CreateOrder --> CollectOrders
        WaitPrice --> CollectOrders

        CollectOrders[Collect All Orders & Invalidations] --> BuildResult[Build DecisionResult]

        subgraph EXECUTE["4ï¸âƒ£ Execution"]
            BuildResult --> HasActions{Any Actions?}
            HasActions -- No --> NoActionCycle([No Actions This Cycle])
            
            HasActions -- Yes --> PlaceOrders
            
            subgraph PlaceOrders["Place Orders"]
                PO1[For Each Order] --> PODelay{Has Delay?}
                PODelay -- Yes --> POSleep[Sleep Delay]
                POSleep --> POPlace[Place on Betfair]
                PODelay -- No --> POPlace
                POPlace --> POCheck{Existing Order?}
                POCheck -- Yes --> POStale{Is Stale?}
                POStale -- Yes --> POCancel[Cancel Stale Order]
                POStale -- No --> POSkip[Skip - Order Active]
                POCheck -- No --> POSend[Send to Betfair API]
            end

            PlaceOrders --> CancelEarlyBirds[Cancel Early Bird Orders]
            CancelEarlyBirds --> ExecuteCashOuts[Execute Cash Outs]
            ExecuteCashOuts --> RecordInvalidations[Record Invalidations]
            RecordInvalidations --> LogSummary[Log Execution Summary]
        end
    end

    subgraph LEGEND["Legend"]
        direction LR
        L1[Pure Function]
        L2[Side Effect]
        L3[Decision Point]
        L4[External API]
    end

    style INIT fill:#e1f5fe
    style MAIN_LOOP fill:#f3e5f5
    style PRICE_SERVICE fill:#fff3e0
    style TRADING_CYCLE fill:#e8f5e9
    style RECONCILE fill:#fce4ec
    style FETCH fill:#e3f2fd
    style DECIDE fill:#fff8e1
    style EarlyBird fill:#e8f5e9
    style NormalMode fill:#fff3e0
    style EXECUTE fill:#ffebee
    style CheckValidations fill:#f5f5f5
    